(function(l,r,u){"use strict";var d=!1;r.behaviors.walletAuth={connector:null,state:"idle",csrfToken:null,attach:function(t,n){!d&&l(t).is(document)&&(d=!0,this.init(t,n))},init:function(t,n){var e=this,o=l,i=n.walletAuth||{},a=i.waapConfig||{};a.projectName=i.projectName||"",a.projectLogo=i.projectLogo||"",a.projectEntryTitle=i.projectEntryTitle||"",a.walletConnectProjectId=i.walletConnectProjectId||"",this.connector=new r.walletAuth.WalletConnector(a);var h=o(".wallet-auth-login-btn",t);h.on("click",function(c){c.preventDefault(),e.handleLogin()});var s=o(".wallet-auth-disconnect-btn",t);s.on("click",function(c){c.preventDefault(),e.handleDisconnect()}),this.connector.init().then(function(){return e.connector.checkSession()}).then(function(c){c?(e.setState("connected"),e.updateUI()):(e.setState("idle"),e.updateUI())}).catch(function(c){console.error("Initialization error:",c),e.setState("error"),e.showError(c.message)}),this.connector.on("disconnect",function(){e.setState("idle"),e.updateUI()}),this.connector.on("accountChanged",function(c){c.length>0?(e.setState("connected"),e.updateUI()):(e.setState("idle"),e.updateUI())})},handleLogin:function(){var t=this,n=this.connector.getAddress();if(n){console.log("Already connected to WaaP, proceeding to authentication"),this.authenticate(n);return}this.setState("connecting"),this.connector.login().then(function(e){if(!e){t.setState("idle");return}console.log("Logged in via:",e),t.setState("connected");var o=t.connector.getAddress();t.authenticate(o)}).catch(function(e){console.error("Login error:",e),t.setState("error"),t.showError(e.message)})},handleDisconnect:function(){this.connector.logout(),this.setState("idle"),this.updateUI()},authenticate:function(t){var n=this;this.setState("signing"),this.updateUI(),this.fetchNonce(t).then(function(e){var o=e.nonce;n.connector.lastNonce=o,n.csrfToken=e.csrf_token;var i=n.createSignMessage(t,o);return n.connector.signMessage(i).then(function(a){return{signature:a,message:i,nonce:o}})}).then(function(e){return n.sendAuthentication(t,e.signature,e.message,e.nonce)}).then(function(e){if(e.success)n.setState("authenticated"),n.showSuccess("Logged in as "+e.username),u.walletAuth.redirectOnSuccess?window.location.href=u.walletAuth.redirectOnSuccess:window.location.reload();else throw new Error(e.error||"Authentication failed")}).catch(function(e){console.error("Authentication error:",e),e.message&&e.message.includes("User rejected")||e.message&&e.message.includes("user rejected")||e.code===4001?(n.setState("connected"),n.updateUI(),n.showError("Signature request was cancelled. Please try again.")):(n.setState("error"),n.updateUI(),n.showError(e.message||"Authentication failed"))})},fetchNonce:function(t){var n=u.walletAuth.apiEndpoint;return fetch(n+"/nonce?wallet_address="+t,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(function(e){if(!e.ok)throw new Error("Failed to fetch nonce");return e.json()})},createSignMessage:function(t,n){var e=window.location.hostname,o=window.location.origin,i=new Date().toISOString(),a=new Date(Date.now()+3e5).toISOString(),h=u.walletAuth.chainId||1,s=e+` wants you to sign in with your Ethereum account:
`;return s+=t+`

`,s+=`Sign in with Ethereum to prove ownership of your wallet.

`,s+="URI: "+o+`
`,s+=`Version: 1
`,s+="Chain ID: "+h+`
`,s+="Nonce: "+n+`
`,s+="Issued At: "+i+`
`,s+="Expiration Time: "+a,s},sendAuthentication:function(t,n,e,o){var i=u.walletAuth.apiEndpoint+"/authenticate";return fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({wallet_address:t,signature:n,message:e,nonce:o,csrf_token:this.csrfToken})}).then(function(a){return a.ok?a.json():a.json().then(function(h){throw new Error(h.error||"Authentication failed")})})},setState:function(t){this.state=t,l("body").attr("data-wallet-auth-state",t)},updateUI:function(){var t=l;t(".wallet-auth-container");var n=t(".wallet-auth-login-btn"),e=t(".wallet-auth-disconnect-btn"),o=t(".wallet-auth-status");switch(n.addClass("visually-hidden"),e.addClass("visually-hidden"),this.state){case"idle":n.removeClass("visually-hidden").find("span").text("Connect Wallet"),o.text("Connect your wallet to login");break;case"connecting":n.removeClass("visually-hidden").prop("disabled",!0).find("span").text("Connecting..."),o.text("Connecting to wallet...");break;case"connected":n.removeClass("visually-hidden").prop("disabled",!1).find("span").text("Sign in"),e.removeClass("visually-hidden"),o.text("Connected: "+this.formatAddress(this.connector.getAddress()));break;case"signing":n.removeClass("visually-hidden").prop("disabled",!0).find("span").text("Signing..."),o.text("Please sign the message in your wallet...");break;case"authenticated":o.text("Authentication successful!");break;case"error":n.removeClass("visually-hidden").prop("disabled",!1).find("span").text("Try Again"),o.text("Authentication failed. Please try again.");break}},showError:function(t){r.behaviors.walletAuth.showMessage?r.behaviors.walletAuth.showMessage(t,"error"):alert(t)},showSuccess:function(t){r.behaviors.walletAuth.showMessage?r.behaviors.walletAuth.showMessage(t,"status"):console.log(t)},formatAddress:function(t){return t?t.substring(0,6)+"..."+t.substring(t.length-4):""},detach:function(t,n){this.connector&&this.connector.destroy()}},r.behaviors.walletAuth.showMessage=function(t,n){n=typeof n<"u"?n:"status";var e=l,o=e(".messages__wrapper");if(o.length){var i=e('<div class="messages messages--'+n+'">'+t+"</div>");o.append(i),setTimeout(function(){i.fadeOut()},5e3)}}})(jQuery,Drupal,drupalSettings);
