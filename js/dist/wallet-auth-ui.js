(function(c,r,l){"use strict";var h=!1;r.behaviors.walletAuth={connector:null,state:"idle",csrfToken:null,attach:function(e,t){!h&&c(e).is(document)&&(h=!0,this.init(e,t))},init:function(e,t){var n=this,s=c,i=t.walletAuth||{},o=i.waapConfig||{};o.projectName=i.projectName||"",o.projectLogo=i.projectLogo||"",o.projectEntryTitle=i.projectEntryTitle||"",o.walletConnectProjectId=i.walletConnectProjectId||"",this.connector=new r.walletAuth.WalletConnector(o);var u=s(".wallet-auth-login-btn",e);u.on("click",function(a){a.preventDefault(),n.handleSignIn()}),this.connector.init().then(function(){n.setState("idle"),n.updateUI()}).catch(function(a){console.error("Initialization error:",a),n.setState("error"),n.showError("Failed to initialize wallet connection")})},handleSignIn:function(){var e=this;this.setState("signing"),this.updateUI(),this.connector.checkSession().then(function(t){return t?(console.log("Using existing wallet session:",t),t):e.connector.login().then(function(n){if(!n)throw{cancelled:!0};return console.log("Logged in via:",n),e.connector.getAddress()})}).then(function(t){return e.performAuthentication(t)}).catch(function(t){if(t&&t.cancelled){e.setState("idle"),e.updateUI();return}console.error("Sign-in error:",t),t.message&&t.message.includes("User rejected")||t.message&&t.message.includes("user rejected")||t.code===4001?(e.setState("idle"),e.updateUI(),e.showError("Signature request was cancelled. Please try again.")):(e.setState("error"),e.updateUI(),e.showError(t.message||"Sign-in failed"))})},performAuthentication:function(e){var t=this;return this.fetchNonce(e).then(function(n){var s=n.nonce;t.connector.lastNonce=s,t.csrfToken=n.csrf_token;var i=t.createSignMessage(e,s);return t.connector.signMessage(i).then(function(o){return{signature:o,message:i,nonce:s}})}).then(function(n){return t.sendAuthentication(e,n.signature,n.message,n.nonce)}).then(function(n){if(n.success)t.setState("authenticated"),t.showSuccess("Signed in as "+n.username),l.walletAuth.redirectOnSuccess?window.location.href=l.walletAuth.redirectOnSuccess:window.location.reload();else throw new Error(n.error||"Authentication failed")})},fetchNonce:function(e){var t=l.walletAuth.apiEndpoint;return fetch(t+"/nonce?wallet_address="+e,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(function(n){if(!n.ok)throw new Error("Failed to fetch nonce");return n.json()})},createSignMessage:function(e,t){var n=window.location.hostname,s=window.location.origin,i=new Date().toISOString(),o=new Date(Date.now()+3e5).toISOString(),u=l.walletAuth.chainId||1,a=n+` wants you to sign in with your Ethereum account:
`;return a+=e+`

`,a+=`Sign in with Ethereum to prove ownership of your wallet.

`,a+="URI: "+s+`
`,a+=`Version: 1
`,a+="Chain ID: "+u+`
`,a+="Nonce: "+t+`
`,a+="Issued At: "+i+`
`,a+="Expiration Time: "+o,a},sendAuthentication:function(e,t,n,s){var i=l.walletAuth.apiEndpoint+"/authenticate";return fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({wallet_address:e,signature:t,message:n,nonce:s,csrf_token:this.csrfToken})}).then(function(o){return o.ok?o.json():o.json().then(function(u){throw new Error(u.error||"Authentication failed")})})},setState:function(e){this.state=e,c("body").attr("data-wallet-auth-state",e)},updateUI:function(){var e=c,t=e(".wallet-auth-login-btn"),n=e(".wallet-auth-status");switch(this.state){case"idle":t.prop("disabled",!1).find("span").text("Sign In"),n.text("");break;case"signing":t.prop("disabled",!0).find("span").text("Signing in..."),n.text("Please complete the sign-in in your wallet...");break;case"authenticated":t.prop("disabled",!0).find("span").text("Signed In"),n.text("Authentication successful!");break;case"error":t.prop("disabled",!1).find("span").text("Try Again"),n.text("Sign-in failed. Please try again.");break}},showError:function(e){r.behaviors.walletAuth.showMessage?r.behaviors.walletAuth.showMessage(e,"error"):alert(e)},showSuccess:function(e){r.behaviors.walletAuth.showMessage?r.behaviors.walletAuth.showMessage(e,"status"):console.log(e)},formatAddress:function(e){return e?e.substring(0,6)+"..."+e.substring(e.length-4):""},detach:function(e,t){this.connector&&this.connector.destroy()}},r.behaviors.walletAuth.showMessage=function(e,t){t=typeof t<"u"?t:"status";var n=c,s=n(".messages__wrapper");if(s.length){var i=n('<div class="messages messages--'+t+'">'+e+"</div>");s.append(i),setTimeout(function(){i.fadeOut()},5e3)}}})(jQuery,Drupal,drupalSettings);
